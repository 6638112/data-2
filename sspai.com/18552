➜一日一技｜只要一台电脑，轻松获取米家设备 token
https://sspai.com/post/63117	6423
<h3>Matrix 首页推荐</h3><p><a href="https://sspai.com/matrix">Matrix</a> 是少数派的写作社区，我们主张分享真实的产品体验，有实用价值的经验与思考。我们会不定期挑选 Matrix 最优质的文章，展示来自用户的最真实的体验和观点。</p><p>文章代表作者个人观点，少数派仅对标题和排版略作修改。</p><p>注：题图来自小米网站。</p><hr><p>不管你是想通过 Homebridge 还是 Home Assistant 把米家设备添加到苹果的 HomeKit 平台上，获取米家设备 token 是绕不开的关键一步。但是，这一步卡住了很多新手，因为很多人不具备安卓手机、Root 能力、命令行操作能力或者寻找传说中的后门版本米家 App 等条件，并且一些网友自制的 miio2 文件解析网站也时常处于打不开的状态。今天，我就教大家用自己手上已有的桌面设备，不管是 Windows 电脑还是 Mac 电脑，不需要写一行代码，就可以简单地获得米家设备的 token。</p><p>思路很简单，第一步是用安卓模拟器获取最新的 miio2 文件，第二步就是用数据库软件解析 miio2 文件得到 token，下面我们就详细地展开说，</p><h2>获取 miio2 文件</h2><p>要想获得 miio2 文件，就必须要通过一个安卓设备。如果没有怎么办？没关系，我们可以在电脑上安装一个安卓模拟器。这一类应用有很多选择，我自己使用的是 <a href="https://mumu.163.com">网易的 MUMU 模拟器</a>，适配了 Windows 和 macOS 双平台。</p><p>安装好安卓模拟器后打开，接着点击底部工具栏上的「安装」按钮，来安装一个旧版的<a href="https://ip3315328883.out.azhimalayanvh.com/fs08/2017/07/27/10/115_dec8b1d531f5861f88f80a2e318a2284.apk?yingid=web_space&amp;packageid=700316678&amp;did=118be4e9e985db2d98090cce88860cbe&amp;ali_redirect_domain=alissl.ucdl.pp.uc.cn&amp;ali_redirect_ex_ftag=6ad34c76341afe0c1e5b4ddf728659ff9635dbd7183d18ea&amp;ali_redirect_ex_tmining_ts=1602601472&amp;ali_redirect_ex_tmining_expire=3600&amp;ali_redirect_ex_hot=100">米家 App</a> 和一个 <a href="https://ip3315328883.out.azhimalayanvh.com/fs08/2020/09/28/11/2_ed8b123ed231daf56189ef07b5685d42.apk?yingid=wdj_web&amp;fname=RE文件管理器&amp;productid=2011&amp;pos=wdj_web%2Fdetail_normal_dl%2F0&amp;appid=74465&amp;packageid=200931934&amp;apprd=74465&amp;iconUrl=http%3A%2F%2Fandroid-artworks.25pp.com%2Ffs08%2F2020%2F09%2F28%2F2%2F2_f4f8fde88fbfa71f85cb6bdc220c6a69_con.png&amp;pkg=com.speedsoftware.rootexplorer&amp;did=fc466ef05784c0f2a580fc7915f3d868&amp;vcode=999497&amp;md5=836d4d4e047e73ca4fedad6c81152eb6&amp;ali_redirect_domain=alissl.ucdl.pp.uc.cn&amp;ali_redirect_ex_ftag=156073bca8dfed22014e935c92f3b45203215e2c2e62745d&amp;ali_redirect_ex_tmining_ts=1602601760&amp;ali_redirect_ex_tmining_expire=3600&amp;ali_redirect_ex_hot=100">RE 文件管理器</a>，懒得找的朋友可以直接用我从豌豆荚上找到的下载链接。</p><p>打开米家 App 并登陆自己的账号后，大家记住千万不要更新，直接去设备页面一个个「打开-关闭」一次自己的设备。</p><figure class="image ss-img-wrapper image_resized" style="width:360px;"><img src="https://cdn.sspai.com//2020/10/13/9695093898fdeeaa65a9aafbbb2738b2.png"></figure><p>回到主界面，打开 RE 浏览器并跳转到路径 <code>/data/data/com.xiaomi.smarthome/databases/</code>，找到 miio2 文件，并检查一下文件的修改时间是不是最近的；点击鼠标不松开选中 miio2 文件后，在界面右上角点击「复制」按钮；然后通过路径 <code>/storage/emulated/0/$MuMu共享文件夹</code> 找到模拟器的共享文件夹，点击右下角的「复制至此」按钮；最后，点击模拟器底部工具栏上的「文件共享」按钮就能在本地文件夹找到 miio2 文件了。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/96eaff74fd0e4084278152dbead847bc.png"></figure><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/a28011b8c8282378467092dd862005c6.png"></figure><h2>解析 miio2 文件</h2><p>miio2 本质上是一个数据库文件，所以我们只需要一个数据库软件就可以读取内容。这里我推荐一个免费开源的 SQL 软件：<a href="https://sqlitebrowser.org">DB Browser for SQLite</a>，适配了 <a href="https://download.sqlitebrowser.org/DB.Browser.for.SQLite-3.12.0-win64.msi">Windows</a> 和 <a href="https://download.sqlitebrowser.org/DB.Browser.for.SQLite-3.12.0.dmg">macOS</a> 双平台，大家可以根据自己的需求下载。</p><p>安装好 DB Browser for SQLite 后，将 miio2 文件使用 DB Browser for SQLite 打开，在左侧的界面中找到名称为 devicerecord 的一个表，右键点击并选中「浏览表」。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/938ae6a52c8e54f2fbf7cc0e2c7a4e0b.png"></figure><p>在打开的数据库中，我们可以找到 <code>name</code> 这一列，其中包含了我们在米家 App 中各个设备的命名。找到相应的设备后，我们就可以在 <code>localIP</code> 这一列找到各设备连接到 WiFi 后的 IP 地址，在 <code>token</code> 这一列就可以找到 32 位 token，最后将它们填写到 config 文件中就可以了。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/9190c43d3fe863258271cbdff1430d2a.jpg"></figure><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/bd5bdc2c5f6b39fee781c8f8e8a0785d.jpg"></figure><p>接下来的步骤就不累述了，还不清楚的朋友可以参考 <a href="https://sspai.com/post/59636">HomeBridge 操作指南：从零开始，将你的米家设备接入 Homekit</a>。</p><p>&gt; 下载少数派&nbsp;<a href="https://sspai.com/page/client">客户端&nbsp;</a>、关注&nbsp;<a href="https://sspai.com/s/J71e">少数派公众号&nbsp;</a>，了解更妙的数字生活 🍃<br>&gt; 想申请成为少数派作者？<a href="https://sspai.com/apply/writing">冲！</a></p><p>© 本文着作权归作者所有，并授权少数派独家使用，未经少数派许可，不得转载使用。</p>
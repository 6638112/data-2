➜一日一技｜只要一台电脑，轻松获取米家设备 token
https://sspai.com/post/63117	6423
<h3>Matrix 首页推荐</h3><p><a href="https://sspai.com/matrix">Matrix</a> 是少数派的写作社区，我们主张分享真实的产品体验，有实用价值的经验与思考。我们会不定期挑选 Matrix 最优质的文章，展示来自用户的最真实的体验和观点。</p><p>文章代表作者个人观点，少数派仅对标题和排版略作修改。</p><p>注：题图来自小米网站。</p><hr><p>不管你是想通过 Homebridge 还是 Home Assistant 把米家设备添加到苹果的 HomeKit 平台上，获取米家设备 token 是绕不开的关键一步。但是，这一步卡住了很多新手，因为很多人不具备安卓手机、Root 能力、命令行操作能力或者寻找传说中的后门版本米家 App 等条件，并且一些网友自制的 miio2 文件解析网站也时常处于打不开的状态。今天，我就教大家用自己手上已有的桌面设备，不管是 Windows 电脑还是 Mac 电脑，不需要写一行代码，就可以简单地获得米家设备的 token。</p><p>思路很简单，第一步是用安卓模拟器获取最新的 miio2 文件，第二步就是用数据库软件解析 miio2 文件得到 token，下面我们就详细地展开说。</p><h2>获取 miio2 文件</h2><p>要想获得 miio2 文件，就必须要通过一个安卓设备。如果没有怎么办？没关系，我们可以在电脑上安装一个安卓模拟器。这一类应用有很多选择，我自己使用的是 <a href="https://mumu.163.com">网易的 MUMU 模拟器</a>，适配了 Windows 和 macOS 双平台。</p><p>安装好安卓模拟器后打开，接着点击底部工具栏上的「安装」按钮，来安装一个旧版的<a href="https://ip3315328883.out.azhimalayanvh.com/fs08/2017/07/27/10/115_dec8b1d531f5861f88f80a2e318a2284.apk?yingid=web_space&packageid=700316678&amp;did=118be4e9e985db2d98090cce88860cbe&amp;ali_redirect_domain=alissl.ucdl.pp.uc.cn&amp;ali_redirect_ex_ftag=6ad34c76341afe0c1e5b4ddf728659ff9635dbd7183d18ea&amp;ali_redirect_ex_tmining_ts=1602601472&amp;ali_redirect_ex_tmining_expire=3600&amp;ali_redirect_ex_hot=100">米家 App</a> 和一个 <a href="https://ip3315328883.out.azhimalayanvh.com/fs08/2020/09/28/11/2_ed8b123ed231daf56189ef07b5685d42.apk?yingid=wdj_web&amp;fname=RE文件管理器&amp;productid=2011&amp;pos=wdj_web%2Fdetail_normal_dl%2F0&amp;appid=74465&amp;packageid=200931934&amp;apprd=74465&amp;iconUrl=http%3A%2F%2Fandroid-artworks.25pp.com%2Ffs08%2F2020%2F09%2F28%2F2%2F2_f4f8fde88fbfa71f85cb6bdc220c6a69_con.png&amp;pkg=com.speedsoftware.rootexplorer&amp;did=fc466ef05784c0f2a580fc7915f3d868&amp;vcode=999497&amp;md5=836d4d4e047e73ca4fedad6c81152eb6&amp;ali_redirect_domain=alissl.ucdl.pp.uc.cn&amp;ali_redirect_ex_ftag=156073bca8dfed22014e935c92f3b45203215e2c2e62745d&amp;ali_redirect_ex_tmining_ts=1602601760&amp;ali_redirect_ex_tmining_expire=3600&amp;ali_redirect_ex_hot=100">RE 文件管理器</a>，懒得找的朋友可以直接用我从豌豆荚上找到的下载链接。</p><p>打开米家 App 并登陆自己的账号后，大家记住千万不要更新，直接去设备页面一个个「打开-关闭」一次自己的设备。</p><figure class="image ss-img-wrapper image_resized" style="width:360px;"><img src="https://cdn.sspai.com//2020/10/13/9695093898fdeeaa65a9aafbbb2738b2.png"></figure><p>回到主界面，打开 RE 浏览器并跳转到路径 <code>/data/data/com.xiaomi.smarthome/databases/</code>，找到 miio2 文件，并检查一下文件的修改时间是不是最近的；点击鼠标不松开选中 miio2 文件后，在界面右上角点击「复制」按钮；然后通过路径 <code>/storage/emulated/0/$MuMu共享文件夹</code> 找到模拟器的共享文件夹，点击右下角的「复制至此」按钮；最后，点击模拟器底部工具栏上的「文件共享」按钮就能在本地文件夹找到 miio2 文件了。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/96eaff74fd0e4084278152dbead847bc.png"></figure><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/a28011b8c8282378467092dd862005c6.png"></figure><h2>解析 miio2 文件</h2><p>miio2 本质上是一个数据库文件，所以我们只需要一个数据库软件就可以读取内容。这里我推荐一个免费开源的 SQL 软件：<a href="https://sqlitebrowser.org">DB Browser for SQLite</a>，适配了 <a href="https://download.sqlitebrowser.org/DB.Browser.for.SQLite-3.12.0-win64.msi">Windows</a> 和 <a href="https://download.sqlitebrowser.org/DB.Browser.for.SQLite-3.12.0.dmg">macOS</a> 双平台，大家可以根据自己的需求下载。</p><p>安装好 DB Browser for SQLite 后，将 miio2 文件使用 DB Browser for SQLite 打开，在左侧的界面中找到名称为 devicerecord 的一个表，右键点击并选中「浏览表」。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/938ae6a52c8e54f2fbf7cc0e2c7a4e0b.png"></figure><p>在打开的数据库中，我们可以找到 <code>name</code> 这一列，其中包含了我们在米家 App 中各个设备的命名。找到相应的设备后，我们就可以在 <code>localIP</code> 这一列找到各设备连接到 WiFi 后的 IP 地址，在 <code>token</code> 这一列就可以找到 32 位 token，最后将它们填写到 config 文件中就可以了。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/9190c43d3fe863258271cbdff1430d2a.jpg"></figure><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/13/bd5bdc2c5f6b39fee781c8f8e8a0785d.jpg"></figure><p>接下来的步骤就不累述了，还不清楚的朋友可以参考 <a href="https://sspai.com/post/59636">HomeBridge 操作指南：从零开始，将你的米家设备接入 Homekit</a>。</p><p>&gt; 下载少数派&nbsp;<a href="https://sspai.com/page/client">客户端&nbsp;</a>、关注&nbsp;<a href="https://sspai.com/s/J71e">少数派公众号&nbsp;</a>，了解更妙的数字生活 🍃<br>&gt; 想申请成为少数派作者？<a href="https://sspai.com/apply/writing">冲！</a></p><p>© 本文着作权归作者所有，并授权少数派独家使用，未经少数派许可，不得转载使用。</p>
➜为自己打造一个「干净」的家庭网络环境：AdGuard Home
https://sspai.com/post/63088	22695
<h3><strong>Matrix 首页推荐</strong></h3><p><a href="https://sspai.com/matrix">Matrix</a> 是少数派的写作社区，我们主张分享真实的产品体验，有实用价值的经验与思考。我们会不定期挑选 Matrix 最优质的文章，展示来自用户的最真实的体验和观点。</p><p>文章代表作者个人观点，少数派仅对标题和排版略作修改。</p><hr><blockquote><p>如果你有在多设备上对去除广告的需求，AdGuard Home 或许是一个不错的选择，它能够给你带来一个清爽的网络世界。</p></blockquote><h2><strong>为什么用户不喜欢广告，以及追踪器？</strong></h2><p>一个好产品，需要广而告之，才能活下去，一部好影片，需要广而告之，才有好的票房。因此便有了广告。从最初的口口相传发展到今日的「千人千面、猜你喜欢」，广告已从单向的传播形式发展成为基于个人喜好专门投放，用户的接受权由主动变为被动。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com//2020/10/11/a16edaaa8dc2d13154844644931dd12c.jpg"><figcaption>网页中的广告</figcaption></figure><p>但当广告时时刻刻充斥在我们的生活，看新闻有贴片广告，刷朋友圈有欧巴的互动广告，看电视剧有 90 秒片头广告，小网站上还有 * 感荷官在线发牌，在《一千五百万个积点》<sup class="ss-footnote" href="https://www.netflix.com/hk/title/70264888" title="Netflix 剧集《黑镜》" footnote-id="1">1</sup>中，男主居住在一个被屏幕环绕的房子里，屏幕全天候地播放广告，想要屏蔽广告只能选择付费，甚至在你屏蔽广告后还会提醒用户「为了网站的持续发展，请关闭广告屏蔽插件」，为了正常浏览网页，用户也只能妥协。</p><p>并非所有广告都是侵入性、影响用户体验的广告，其中不乏制作精良、体验良好的广告，在由 The Coalition for Better Ads 提出的 <a href="https://www.betterads.org/standards/">Better Ads Standards</a> 中，边栏广告、小型贴片广告、顶栏 / 底部广告对用户的浏览体验影响较小，浮窗广告、大型 / 全屏贴片广告、自动播放的视频广告则会影响用户心情。而用户只能选择全部屏蔽，广告商的收益会受到极大的影响。除了广告，一并被屏蔽掉的还有信息收集与分析工具，如 Google Analytics，此类工具可以在不过分侵犯用户隐私的前提下帮助网站主改善网站运营，提供更好的内容。</p><h2><strong>广告拦截 / 反追踪插件是如何起作用的？</strong></h2><p>广告拦截插件的实现原理大致可分为三种 —— Url 匹配屏蔽、流量过滤、网页 DOM 过滤。前两者属于 Request Blocking，后者属于 Page Code Filtering &amp; CSS Injection and JavaScript<sup class="ss-footnote" href="https://kb.adguard.com/en/general/how-ad-blocking-works" title="来源：AdGuard Home: How ad blocking works" footnote-id="2">2</sup>。</p><h3>Url 匹配屏蔽</h3><p>广告联盟的广告资源通常会与网站站点分开放置，以百度联盟为例，百度联盟的广告域名为 <code>https://cpro.baidustatic.com/</code>，因此我们可以单独屏蔽来自 <code>https://cpro.baidustatic.com/</code> 的内容，同时不会影响网站内容的正常加载。当网站域名与广告资源域名相同时，基于 Url 匹配的广告屏蔽方法如同「南橘北枳」。</p><h3>网页 DOM 过滤</h3><p>DOM（<i>Document Object Model，文件物件模型</i>），在 W3C DOM 标准<sup class="ss-footnote" href="https://www.w3.org/TR/dom41/#introduction-to-the-dom" title="W3C 文档对象模型 （DOM） 是中立于平台和语言的接口，它允许程序和脚本动态地访问和更新文档的内容、结构和样式" footnote-id="3">3</sup>下，网页中的任何一个标签、元素都是树状结构中的一个节点。网页 DOM 过滤广告弥补了基于匹配 Url 屏蔽广告的缺点，通过 CSS3 Selector 定位到广告 DOM 元素，使用 <code>display=none!important</code> 等语法隐藏广告。DOM 过滤过程发生在网页加载时，缺点是无法拦截通过 Ajax、Pjax 新加载的广告内容。</p><h3>流量过滤</h3><p>在实体网关 / 虚拟网关处设置过滤器，对具备广告特征的流量实施拦截，如网站使用了 Https 加密，则采取 MITM（<i>Man-in-the-middle attack，中间人攻击</i>）对 Https 加密流量进行解密，并对其中的广告流量进行拦截，这一功能在部分第三方路由器固件非常常见，如 KoolProxy、广告屏蔽大师 Plus。</p><p>在解密前，客户端上需要安装并信任由广告拦截软件生成的证书，如果网站采取了 Https 加密并需要验证证书，流量过滤的广告拦截功能则会影响网页的正常浏览。此外，如果设备性能偏低，这种拦截方式一定程度上会减慢网速。</p><p>以往我们习惯在电脑浏览器上使用 AdBlock Plus、AdGuard、Ghostery、uBlock Origin 之类的广告拦截与隐私防护插件，从而去除网页上扰人的广告。对于 Android 与 iOS，受限于系统权限（<i>如 Root 权限、系统证书与用户证书</i>）、过滤模式，想在手机上「找到一块净土」，需要花费一番功夫。</p><p>上述方法操作后只对单个设备生效，随着设备数量的增加，逐个逐个去设置十分麻烦，此外还会增加软件的订阅费用，面对智能电视、智能音箱，传统的广告拦截软件难以应付。而如果家中有使用软路由、NAS 甚至是树莓派，不妨试试在上面安装 DNS 广告拦截软件，实现网关级的广告拦截。</p><p>今天向大家介绍的 DNS 广告过滤软件是 AdGuard 团队开发的 AdGuard Home。</p><blockquote><p>AdGuard Home 是一款全网广告拦截与反跟踪软件。在您将其安装完毕后，它将保护您所有家用设备，同时您不再需要安装任何客户端软件。随着物联网与连接设备的兴起，掌控您自己的整个网络环境变得越来越重要。</p><p>—— AdGuard Home</p></blockquote><p>AdGuard Home 是 AdGuard 开源的一个私人 DNS 服务端，只需在网关部署，即可实现全局域网的广告拦截与隐私反追踪。在 DNS 解析的过程中，匹配规则库内的 Url 进行拦截，同时在客户端中，还可以通过自定义过滤规则实现网页 DOM 的拦截。</p><h2><strong>如何安装 AdGuard Home？</strong></h2><p>基于 Golang 编写的 AdGuard Home，<a href="https://adguard.com/zh_cn/adguard-home/overview.html">官方支持</a> 运行在 Linux 32 位 / 64 位 / ARM（v6 / v7）/ MIPS、FreeBSD、Windows、macOS、Docker 内，以及由第三方开发者维护的 <a href="https://github.com/rufengsuixing/luci-app-adguardhome">OpenWrt 软件包</a> 、<a href="https://github.com/hassio-addons/addon-adguard-home">Home Assistant 拓展</a> 和 <a href="https://aur.archlinux.org/packages/adguardhome/">Arch Linux</a>。</p><p>由于篇幅限制，下文将介绍如何 NAS（系统：Debian 10）以及 Windows 电脑（系统：Windows 10）上安装与配置 AdGuard Home，其它设备请查看 AdGuard Home - Wiki 中的介绍或网友们的教程。局域网中的 DNS 服务器推荐运行在软路由、NAS 或树莓派等长期保持开机的设备上，避免因设备关闭导致 DNS 无法正常解析。</p><p>本人不推荐在普通路由器上运行 AdGuard Home、Pi-Hole 等工具，路由器的性能对 AdGuard Home 的运行效率有着较大影响。根据本人测试，Pi-Hole 空载需占用 15MB 内存（不含缓存），AdGuard Home 空载需占用 20 MB 内存（不含缓存），AdGuard Home 带机 13 台、过滤规则 74000+ 条时占用 700MB 内存（含缓存）。</p><p>AdGuard Home 支持以二进制文件、Docker 容器两种方式安装、运行，可以根据个人喜好选择合适的方式安装。如果运行设备的系统涉及到重要业务的运行，如 NAS 文件存储、Web 服务器等，推荐使用 Docker 安装，不易受到业务应用的影响。</p><blockquote><ul><li>以下教程需要一定的计算机操作基础、路由器使用基础与服务器使用基础</li><li>下文的需要使用的信息如下所示，不同用户的设置有所差异，请自行更改<ul><li>NAS 局域网 IP：10.2.168.100</li><li>AdGuard Home 后台地址：<a href="http://10.2.168.100:3000">http://10.2.168.100:3000</a></li><li>私人 AdGuard Home DNS 地址：10.2.168.100:53</li></ul></li></ul></blockquote><h3><strong>下载、安装 AdGuard Home</strong></h3><p>前往 <a href="https://adguard.com/zh_cn/adguard-home/overview.html">AdGuard Home 官网</a> 下载安装包。</p><h4><strong>Windows 系统</strong></h4><p><strong>下载二进制文件</strong></p><p>使用浏览器 / 下载工具下载：<a href="https://static.adguard.com/adguardhome/edge/AdGuardHome_windows_amd64.zip">https://static.adguard.com/adguardhome/edge/AdGuardHome_windows_amd64.zip</a></p><p><strong>解压压缩包得到 ​</strong><code><strong>AdGuardHome.exe</strong></code><strong>​ 文件</strong></p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/964c3ebba21c99d093cc1f98e622d3b6"><figcaption>解压文件</figcaption></figure><p><strong>将 </strong><code><strong>AdGuardHome.exe</strong></code><strong> 移动到 ​</strong><code><strong>C:\Program Files\AdGuard_Home​</strong></code><strong> 文件夹中</strong></p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/45cb023ea66aa8adbcdb053e4c422b13"><figcaption>移动文件</figcaption></figure><p><strong>以管理员身份打开命令提示符，执行以下命令</strong></p><pre class="language-shell"><code>cd "C:\Program Files\AdGuard_Home"
.\AdGuardHome.exe --service install</code></pre><p>&nbsp;</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/3d70535e42200a2cb7dfa8702492c173"><figcaption>执行命令</figcaption></figure><p>当提示 <code>AdGuard Home is successfully installed and will automatically start on boot.</code> 即表示 AdGuard Home 在当前系统上安装成功。在命令行中会显示管理后台的地址与端口，默认为 ​<code>http://IP:3000</code>​。</p><h4><strong>Linux 系统</strong></h4><p>Linux 用户需使用 root 用户登入 SSH，并执行对应系统版本的命令。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/9d79f0eda43bdfca3de72cf872c5ef10"><figcaption>登入 SSH</figcaption></figure><p><strong>下载、解压、移动二进制文件</strong></p><pre class="language-shell"><code>#Linux x64
wget https://static.adguard.com/adguardhome/edge/AdGuardHome_linux_amd64.tar.gz -O AdGuardHome.tar.gz
#Linux i386
wget https://static.adguard.com/adguardhome/edge/AdGuardHome_linux_386.tar.gz -O AdGuardHome.tar.gz
#Linux ARMv7
wget https://static.adguard.com/adguardhome/edge/AdGuardHome_linux_armv7.tar.gz -O AdGuardHome.tar.gz
#Linux ARMv6
wget https://static.adguard.com/adguardhome/edge/AdGuardHome_linux_armv6.tar.gz -O AdGuardHome.tar.gz</code></pre><p>为了方便管理，我们将二进制文件移动到 ​/usr/local/AdGuard_Home/​ 文件夹中。</p><pre class="language-shell"><code>#解压
tar xvf AdGuardHome.tar.gz
#移动文件
mkdir /usr/local/AdGuard_Home
mv AdGuardHome/AdGuardHome /usr/local/AdGuard_Home</code></pre><p>&nbsp;</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/31ea9ee66c9f8ce51cd0354880eb1a51"><figcaption>下载、解压文件</figcaption></figure><p><strong>安装 AdGuard Home 到系统中</strong></p><pre class="language-shell"><code>cd /usr/local/AdGuard_Home
./AdGuardHome --service install</code></pre><p>&nbsp;</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/aa37eb8d813cc2127f9c5b52e031e180"><figcaption>安装 AdGuard Home</figcaption></figure><p>当提示<code> AdGuard Home is successfully installed and will automatically start on boot.</code> 即表示 AdGuard Home 在当前系统上安装成功。在终端上会显示管理后台的地址与端口，默认为 <code>​http://IP:3000​</code>。</p><h4><strong>Docker 容器</strong></h4><p>除了直接安装到系统，我们还可以通过 Docker 来安装 AdGuard Home。安装 Docker、添加 Docker 镜像源的教程请自行搜寻。</p><p><strong>部署准备</strong></p><pre class="language-shell"><code>#拉取 AdGuard Home Docker镜像
docker pull adguard/adguardhome
#设置 AdGuard Home 的配置文件存储位置
mkdir /etc/AdGuard_Home/</code></pre><p>&nbsp;</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/e68c8876d718424cd0a36727e4eb5f96"><figcaption>Docker 准备</figcaption></figure><p><strong>创建容器</strong></p><pre class="language-shell"><code>#创建 AdGuard Home 容器
docker run \
--name AdGuard_Home \
-v /etc/AdGuard_Home/:/opt/adguardhome/work \
-v /etc/AdGuard_Home/:/opt/adguardhome/conf \
-p 53:53/tcp -p 53:53/udp -p 67:67/udp -p 70:68/tcp -p 70:68/udp -p 3000:80/tcp -p 446:443/tcp -p 853:853/tcp -p 3000:3000/tcp \
--restart=always \
-d adguard/adguardhome</code></pre><p>&nbsp;</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/08025f789f31b4a612cff5acf11d8b4f"><figcaption>创建容器</figcaption></figure><p>创建容器前务必检查端口是否会发生冲突，因为我的 NAS 使用了 OpenMediaVault，53（Debian / Ubuntu 系统中的本地 DNS 服务器）、68（DHCP 客户端）、80（OpenMediaVault 网页后台）、443（Https）端口会发生冲突，便将对应端口调整为 70、446、3000，53 端口冲突可通过关闭本地 DNS 服务器解决。如有端口被占用，可以通过 ​<code>netstat -tunlp | grep 端口号</code>​ 查询占用进程。</p><p>容器部署成功后，通过 ​<code>http://IP:3000​</code> 成功打开安装界面即表示部署成功。</p><h3><strong>初始化设置</strong></h3><h4><strong>进入安装向导</strong></h4><p>在浏览器中打开 AdGuard Home 的后台，进入安装向导，点击 “开始配置”。默认后台地址为：​<code>http://IP:3000/​</code></p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/9c40d9a936426428c81e2dcc0d8fa581"><figcaption>安装向导</figcaption></figure><h4><strong>设置网络接口</strong></h4><p>将后台的访问端口更改为 3000，避免与 NAS 后台的 80 端口发生冲突，DNS 端口保持为 53 即可。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/295233b562a689d3f84e8e17be17ff1c"><figcaption>网络接口</figcaption></figure><h4><strong>设置管理员账户</strong></h4><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/fc0626dc456bb64afdca829550d22fdd"><figcaption>设置管理员账户</figcaption></figure><h4><strong>完成初始化设置</strong></h4><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/98937cd9512d4decd073d6ac48d5e76e"><figcaption>完成初始化设置</figcaption></figure><h3><strong>后期配置</strong></h3><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/7f28ffa3575210cb4414c667e30a7bf0"><figcaption>AdGuard Home 后台</figcaption></figure><p>安装完成后，我们还需要进一步的设置，根据需要作出一定的优化。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/ed909765686f39e77bb34390e48d643a"><figcaption>设置项目列表</figcaption></figure><h4><strong>常规设置</strong></h4><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/9c69f127114ca1e64637096bbd5237da"><figcaption>常规设置</figcaption></figure><ul><li>过滤器更新间隔：DNS 过滤清单默认更新间隔，一般为 3 天 - 7 天</li><li>使用 AdGuard “浏览安全” 网页服务：作用与 Chrome 网页安全性检查类似，开启后，当用户访问存在潜在威胁的网站时，AdGuard 会主动拦截并弹出提示</li><li>使用 AdGuard “家长控制” 服务：如果家中有尚未成年的孩子，建议开启，避免访问不良网站</li><li>强制安全搜索：隐藏 Bing、Google、Yandex、YouTube 网站上 NSFW 等不适宜的内容</li><li>查询记录保留时间：AdGuard Home 服务端采用 Sqlite 文件数据库存储日志，长时间保留可能会降低运行速度，同时占用大量的储存空间，家庭用户一般保留 24 小时 - 7 天即可</li><li>统计数据保留时间：用于仪表盘的数据展示，一般保留 24 小时 - 7 天即可</li></ul><h4><strong>DNS 设置</strong></h4><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/3208bebf5c0e72438a08f296e4635024"><figcaption>DNS 设置</figcaption></figure><ul><li>上游 DNS 服务器：AdGuard Home 的上游 DNS 服务器，可参考下方推荐列表，一般保留 1 - 2 个即可。AdGuard Home 除了可以作为广告过滤网关，如果设置了纯净 DNS 后，还可以避免运营商的 DNS 劫持</li><li>BootStrap DNS 服务器地址：作为 DoH / DoT DNS 的前置 DNS 解析器，可参考下方推荐列表</li><li>查询方式、速度限制、EDNS、DNSSEC、拦截模式、DNS 缓存设置、访问设置可根据需要进行调整，一般保持默认设置即可</li></ul><h4><strong>DNS 服务器推荐</strong></h4><p>不同地区连接至 DNS 服务器的速度各有差异，各位可以通过 Ping 测速的方式寻找当地连接延迟最低的 DNS 服务器。更多 DNS 服务器可以在 <a href="https://kb.adguard.com/zh/general/dns-providers">AdGuard 文档</a>中找到。</p><figure class="table"><table><tbody><tr><td>DNS 提供商</td><td>类别</td><td>地址</td></tr><tr><td rowspan="3">阿里</td><td>IPv4 DNS</td><td>223.5.5.5</td></tr><tr><td>IPv6 DNS</td><td>2400:3200:baba::1</td></tr><tr><td>DNS-over-Https</td><td>https://dns.alidns.com/dns-query</td></tr><tr><td rowspan="2">DNSPod</td><td>IPv4 DNS</td><td>119.29.29.29</td></tr><tr><td>DNS-over-Https</td><td>https://doh.pub/dns-query</td></tr><tr><td>114</td><td>IPv4 DNS</td><td>114.114.114.114</td></tr><tr><td rowspan="3">Google</td><td>IPv4 DNS</td><td>8.8.8.8</td></tr><tr><td>IPv6 DNS</td><td>2001:4860:4860::8888</td></tr><tr><td>DNS-over-Https</td><td>https://dns.google/dns-query</td></tr><tr><td rowspan="3">Cloudflare</td><td>IPv4 DNS</td><td>1.1.1.1</td></tr><tr><td>IPv6 DNS</td><td>2606:4700:4700::1111</td></tr><tr><td>DNS-over-Https</td><td>https://dns.cloudflare.com/dns-query</td></tr></tbody></table></figure><h4><strong>DNS 封锁清单</strong></h4><p>为了更好地发挥 AdGuard Home 去广告的功能，仅依靠默认的过滤规则是不够的，但也不宜过多，过多的过滤规则会影响解析的速度，各位可以根据需要添加过滤规则。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/1c9b2307f34bd94114006743673afbfe"><figcaption>DNS 封锁清单</figcaption></figure><figure class="table"><table><thead><tr><th>名称</th><th>简介</th><th>地址</th></tr></thead><tbody><tr><th>AdGuard DNS Filter</th><td>AdGuard 官方维护的广告规则，涵盖多种过滤规则</td><td>https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_15_DnsFilter/filter.txtv</td></tr><tr><th>EasyList</th><td>Adblock Plus 官方维护的广告规则</td><td>https://easylist-downloads.adblockplus.org/easylist.txt</td></tr><tr><th>EasyList China</th><td>面向中文用户的 EasyList 去广告规则</td><td>https://easylist-downloads.adblockplus.org/easylistchina.txt</td></tr><tr><th>EasyPrivacy</th><td>反隐私跟踪、挖矿规则</td><td>https://easylist-downloads.adblockplus.org/easyprivacy.txt</td></tr><tr><th>Halflife 规则</th><td>涵盖了 EasyList China、EasyList Lite、CJX ’s Annoyance、乘风视频过滤规则，以及补充的其它规则</td><td>https://gitee.com/halflife/list/raw/master/ad.txt</td></tr><tr><th>Xinggsf 乘风过滤</th><td>国内网站广告过滤规则</td><td>https://gitee.com/xinggsf/Adblock-Rule/raw/master/rule.txt</td></tr><tr><th>Xinggsf 乘风视频过滤</th><td>视频网站广告过滤规则</td><td>https://gitee.com/xinggsf/Adblock-Rule/raw/master/mv.txt</td></tr><tr><th>MalwareDomainList</th><td>恶意软件过滤规则</td><td>https://www.malwaredomainlist.com/hostslist/hosts.txt</td></tr><tr><th>Adblock Warning Removal List</th><td>去除禁止广告拦截提示规则</td><td>https://easylist-downloads.adblockplus.org/antiadblockfilters.txt</td></tr><tr><th>Anti-AD</th><td>命中率高、兼容性强</td><td>https://anti-ad.net/easylist.txt</td></tr><tr><th>Fanboy’s Annoyances List</th><td>去除页面弹窗广告规则</td><td>https://easylist-downloads.adblockplus.org/fanboy-annoyance.txt</td></tr></tbody></table></figure><p>以浏览国内网站为主的用户可以使用 anti-AD + Halflife 过滤规则，如有浏览国外网站的需要，可以根据需要添加 AdGuard DNS Filter、Fanboy's Annoyances List 等规则。不同规则之间会存在重叠的情况，可以通过 AdGuard Home 的拦截日志分析哪些规则的使用频率最高，哪些规则拦截频率最低，再加以取舍。</p><h3><strong>替换设备 DNS</strong></h3><p>完成 AdGuard Home 的设置后，便可将 AdGuard Home 的 DNS 地址部署到局域网设备上。</p><h4><strong>更改路由器 DNS 地址</strong></h4><p>不同品牌路由器修改的方法各有差异，具体步骤可参照说明书或网上的教程（路由器型号 + 更改 DNS），下方以 Redmi AC2100 路由器为例。</p><p>打开并登录路由器的后台管理页面。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/248b318854208ede99ffd26d27078dbf"><figcaption>路由器后台</figcaption></figure><p>在局域网设置中找到 DNS 设置，将首选 DNS 服务器更改为 AdGuard Home 的 DNS 地址，可设置为其它的 DNS 服务商，避免因 AdGuard Home 服务器宕机而导致局域网无法访问互联网。更改完成后点击保存即可。在路由器更改 DNS 后，局域网内的所有设备的 DNS 解析都会通过 AdGuard Home DNS 完成，实现过滤广告与反隐私跟踪。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/da85deaf109da54f667017873a7e460c"><figcaption>DNS 设置</figcaption></figure><h4><strong>更改手机 DNS 地址</strong></h4><p><strong>Android 设备</strong></p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/2aaafbf60f6f8bf321ad875d5439cf68"><figcaption>更改 Android 设备 DNS</figcaption></figure><ul><li>进入「设定 - 网络和互联网 - Wi-Fi」，点击当前已连接网络的一旁的设置按钮</li><li>在 Wi-Fi 详情信息页面点击「编辑」按钮</li><li>找到「IP 设定」</li><li>分别输入该设备的 IP、网关与 AdGuard Home 服务器地址</li></ul><p><strong>iOS 设备</strong></p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/01f22e96eef7c6ae63c7addf2721e17a"><figcaption>更改 iOS 设备 DNS</figcaption></figure><ul><li>进入「设置 - 无线局域网」，点击当前已连接网络的名称</li><li>在 Wi-Fi 详情信息页面找到「配置 DNS」</li><li>切换为手动设置，并输入 AdGuard Home 服务器地址</li></ul><h4><strong>更改电脑 DNS 地址</strong></h4><p><strong>macOS 设备</strong></p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/692382abb3586cd04517c28f4fb486dd"><figcaption>更改 macOS 设备 DNS</figcaption></figure><ul><li>打开「网络偏好设置」，选中当前已连接的网络，点击右下方的「高级」按钮</li><li>切换到「DNS」选项卡，填写 AdGuard Home 服务器地址</li></ul><p><strong>Windows 设备</strong></p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/1ded533f812066eb3d692b377645f87e"><figcaption>更改 Windows 设备 DNS</figcaption></figure><ul><li>打开「Windows 设置 - 网络和 Internet」，点击「更改适配器选项」</li><li>选中有线 / 无线网卡，点击工具栏「更改此连接的设置」</li><li>找到「Internet 协议版本 4」，点击「属性」按钮</li><li>填写 DNS 服务器，点击「编辑」按钮</li></ul><h2><strong>使用效果</strong></h2><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/36877a0298d39ea51296a9fa6ef9a47f"><figcaption>运行 12 小时拦截效果</figcaption></figure><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2020/10/11/article/7e11a63dfa69dd4c530f390c0bc76fd4"><figcaption>网页拦截效果</figcaption></figure><p>使用 AdGuard Home 处理局域网中的 DNS 请求后（时长 12 小时），有 6% 的 DNS 请求被拦截下来。在客户端上，浏览网页时的浮窗广告、页面弹窗都能够被阻挡，一些隐私追踪服务同样也被 AdGuard 屏蔽。</p><p>当然，AdGuard Home 也不是万能的，在官方文档中说到，面对广告资源域名与网站域名相同、Twitch 广告、YouTube 视频广告、国外社交平台上的赞助推文，AdGuard Home 无能为力，只能借助 Adblock Plus、AdGuard、uBlock Origin 等内容拦截工具。</p><h2><strong>常见问题</strong></h2><h3><strong>端口冲突</strong></h3><p>在 Linux 设备上运行 AdGuard Home，通常会出现 53（本地 DNS 服务器）、68（DHCP 客户端）、80（Http）、443（Https） 端口冲突的问题，可以通过 ​netstat -tunlp | grep 端口号​ 查询占用进程。有两种解决方案：使用不同端口、停用冲突进程。</p><p>如果是通过 Docker 方式运行 AdGuard Home，出现 ​<code>listen udp 0.0.0.0:53: bind: address already in use​</code> 的提示，需要手动处理，方法如下：</p><pre class="language-shell"><code>#停止 DNSStubListener
systemctl stop systemd-resolved
#创建文件夹（如果不存在）
mkdir /etc/systemd/resolved.conf.d/
#使用 Nano 创建配置文件
nano /etc/systemd/resolved.conf.d/adguardhome.conf</code></pre><p>在编辑器中粘贴以下内容：</p><pre class="language-null"><code>[Resolve]
DNS=127.0.0.1
DNSStubListener=no</code></pre><p>保存后执行以下命令。</p><pre class="language-shell"><code>#创建备份
sudo mv /etc/resolv.conf /etc/resolv.conf.backup
#将 /etc/resolv.conf 链接至 /run/systemd/resolve/resolv.conf
ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
#重启 DNSStubListener
systemctl restart systemd-resolved</code></pre><p>完成后使用 ​<code>netstat -tunlp | grep 53</code>​ 命令检查是否依旧有进程占用 53 端口，如无冲突，重启 AdGuard Home 容器即可。</p><h3>平均处理时间过长？</h3><p>以下几个因素会使 AdGuard Home 的处理时间过长：</p><ul><li>本地到上游DNS的速度：如果本地运营商的 DNS 没有 DNS 劫持、投毒的问题，建议使用运营商 DNS + 公共 DNS 的方案，DNS 速度可以通过 Ping 值比较。并在 AdGuard Home 中选择以「并行请求」的方式处理 DNS 请求</li><li>浏览安全、家庭控制与强制安全搜索服务：以上三个功能，在 DNS 请求时不会经过 DNS 缓存，直接向上游 DNS 服务器请求，从而减慢 AdGuard Home 的处理速度</li><li>IPv6：如果使用的宽带、校园网不支持 IPv6，可以禁用解析 IPv6，提高响应速度</li><li>过滤规则：过多的过滤规则会影响响应速度，宁缺毋滥，选择最合适自己的规则，一般保留 3 - 4 个广告过滤规则即可。</li><li>统计周期： 在完成以上优化后，发现平均处理时间并没有太大改变，使用体验上也并不慢，有可能是因为统计周期过长，将优化前的结果计入，导致优化前后的结果无太大差异。不妨将仪表盘的统计周期缩短为 24 小时再看看。</li></ul><p>完成以上步骤后使用体验比没有使用 AdGuard Home 还要糟糕，问题有亿点严重了。这个时候需要查找 AdGuard Home 的日志，寻找问题的原因。</p><h3>部分网页被 AdGuard Home 误杀</h3><p>如果一些网页被 AdGuard Home 误杀，可以在 AdGuard Home 的日志寻找是否被拦截。如果与规则发生冲突，需要将误杀网址通过自定义过滤规则添加至白名单中，或选择其它的过滤规则。常见的冲突有网站统计服务（Google Analytics）、广告联盟等。</p><h3>自定义过滤规则</h3><p>AdGuard Home 的过滤规则兼容 Adblock 语法、Hosts 语法及 Domain-only 语法。</p><figure class="table"><table><thead><tr><th><strong>语法</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><p style="margin-left:0px;"><code>||example.org^</code></p></td><td>拦截 example.org 域名及其所有子域名</td></tr><tr><td><p style="margin-left:0px;"><code>@@||example.org^</code></p></td><td>放行 example.org 及其所有子域名</td></tr><tr><td><p style="margin-left:0px;"><code>127.0.0.1 example.org</code></p></td><td>将 example.org 解析到 127.0.0.1</td></tr><tr><td><p style="margin-left:0px;"><code>/REGEX/</code></p></td><td>阻止访问与 example_regex_meaning 匹配的域</td></tr><tr><td><p style="margin-left:0px;"><code>! 这是一行注释</code></p></td><td>只是一条注释</td></tr><tr><td><p style="margin-left:0px;"><code># 这是一行注释</code></p></td><td>只是一条注释</td></tr></tbody></table></figure><h3>能否将 AdGuard Home DNS 与 Surge / Clash 网关结合使用？</h3><p>可以。Surge 与 Clash 分别提供了 <code>dns-server</code> 与 <code>dns-nameserver</code> 字段以供用户修改 DNS 解析服务器，在配置文件中填入 AdGuard Home 的 DNS 服务器地址即可。</p><h2><strong>尾言</strong></h2><p>如果你有在多设备上对去除广告的需求，恰巧手上有一台可以发光发热的树莓派、软路由、NAS 甚至是旧电脑，AdGuard Home 或许是一个不错的选择，它能够给你带来一个清爽的网络世界。同类的工具还有 Pi-Hole，升级到 5.0 版本后，除了缺乏多语言支持、内置的过滤器选择较少、兼容性弱于 AdGuard Home 的不足外，使用体验与 AdGuard Home 无太大差异。</p><h2><strong>参考篇目</strong></h2><ul><li><a href="https://github.com/AdguardTeam/AdGuardHome/wiki">AdGuard Home Wiki</a></li><li><a href="https://kb.adguard.com/en/general/how-ad-blocking-works">AdGuard: How ad blocking works</a></li><li><a href="https://hub.docker.com/r/adguard/adguardhome">How to run AdGuard Home in Docker with 'resolved' daemon</a></li><li><a href="https://sspai.com/post/56617">想获得「干净」的网页浏览体验？你需要这份全平台去广告指南</a></li><li><a href="https://www.leeyiding.com/archives/50/">AdGuard 语法规则 —— 如何创建属于你自己的广告过滤器</a></li><li><a href="https://www.w3.org/TR/dom41/#introduction-to-the-dom">W3C DOM</a></li><li><a href="https://www.betterads.org/standards/">The Coalition for Better Ads - Better Ads Standards</a></li></ul><p>&gt; 下载少数派 <a href="https://sspai.com/page/client">客户端 </a>、关注 <a href="https://sspai.com/s/J71e">少数派公众号 </a>，了解更妙的数字生活 🍃</p><p>&gt; 想申请成为少数派作者？<a href="https://sspai.com/apply/writing" target="_blank">冲！</a></p>